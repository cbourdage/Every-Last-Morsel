<?php
$_session = Bootstrap::getSingleton('user/session');
$_plot = $this->plot;
?>
<?php echo $this->Message()->render(); ?>
<div class="inner-content-wrapper plot">
	<div class="top">
		<h2><span class="editable" data-title="Plot Name" data-name="name" data-type="input"><?php echo $_plot->getName(); ?></span></h2>
		<ul class="list-inline">
			<li><strong>Location</strong> <?php echo $_plot->getZipcode(); ?></li>
		</ul>

		<p class="controls">
			<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user)) : ?>
				<a href="#" class="btn" title="Edit Plot Information" data-edit="editable" data-target="#editModalPlot">Edit</a>
			<?php endif; ?>
			<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user) && $this->User()->canShowTips()) : ?>
				<a href="#"  title="Tool tips!" class="tips">Tool Tips</a>
			<?php endif; ?>
		</p>
	</div>

	<section class="photo-timeline blocked-content">
		<?php echo $this->partial('plot/view/images.phtml', array('plot' => $_plot)); ?>
	</section>

	<ul id="tabMenu" class="list-inline">
		<li><a href="#plots" title="Where I'm Growing">Users</a></li>
		<li><a href="#socializing" title="What I'm Sharing">Status</a></li>
		<li><a href="#crops" title="What I'm Growing">Crops</a></li>
		<li><a href="#about" title="Who am I?">About</a></li>
	</ul>

	<section id="users" class="blocked-content">
		<?php echo $this->partial('plot/user/list.phtml', array('users' => $_plot->getUsers())); ?>
		<?php if ($_session->isLoggedIn() && !$_plot->isAssociated($_session->user)) :  ?>
			<?php echo $this->partial('plot/user/associate.phtml', array('plot' => $_plot)); ?>
		<?php endif; ?>
	</section>

	<section id="socializing" class="blocked-content comments">
		<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user)) :  ?>
			<?php echo $this->partial('plot/comment/form.phtml', array('plot' => $_plot)); ?>
		<?php endif; ?>
		<?php echo $this->partial('plot/comment/list.phtml', array('plot' => $_plot)); ?>
	</section>

	<section id="crops" class="blocked-content">
		Crop display
	</section>

	<section id="about" class="blocked-content">
		<div class="editable" data-title="About this plot" data-name="about" data-type="textarea">
			<?= $_plot->getAbout() ? $_plot->getAbout() : 'A little about this plot...'; ?>
		</div>
	</section>
</div>

<div class="modal hide fade edit-modal" id="editModalPlot">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">Ã—</a>
		<h3></h3>
	</div>
	<div class="modal-body">
		<form action="<?= $this->url('plot/save'); ?>" type="post" id="editFormPlot">
			<input type="hidden" data-name="identifier" name="plot_id" value="<?= $_plot->getId(); ?>" />
			<input type="hidden" data-name="update" name="plot_update" value="" />
			<div class="wrapper"></div>
		</form>
	</div>
	<div class="modal-footer">
		<a href="#" class="btn" data-dismiss="modal">Close</a>
		<a href="#" class="btn btn-primary" data-submit="form" data-form="#editFormPlot">Save</a>
	</div>
</div>


<script defer="defer">
!function($) {
	$('#commentForm').on('submit', function(e) {
		e.preventDefault();
		var $form = $(this);
		var $alert = $form.find('.alert');

		if ($alert.length) {
			$alert.alert('close');
		}

		$.ajax({
			url: $form.attr('action'),
			type: 'post',
			data: $form.serialize(),
			success: function(response) {
				if (!elm.success(response)) {
					return;
				}

				if (response.success) {
					$.formReset($form);
					var $li = $(response.html).hide();
					$('.feed', '#socializing').prepend($li);
					$li.fadeIn();
				} else {
					$alert = jQuery.createErrorAlert(response.message).hide();
				}

				if ($alert.length) {
					$form.prepend($alert);
					$alert.fadeIn();
				}
			},
			error: function() {
				elm.error("Oops! We've encountered some troubles. Try again shortly!", $form, 'prepend');
			},
			exception: function() {
				elm.error("Oops! We've encountered some troubles. Try again shortly!", $form, 'prepend');
			}
		});
		return false;
	});
}(window.jQuery);
</script>