<?php
$_session = Bootstrap::getSingleton('user/session');
$_plot = $this->plot;
?>
<?php echo $this->Message()->render(); ?>
<div class="inner-content-wrapper plot">
	<div class="top">
		<h2><span class="editable" data-title="Plot Name" data-name="name" data-type="input"><?php echo $_plot->getName(); ?></span></h2>
		<ul class="list-inline">
			<li><strong>Location</strong> <?php echo $_plot->getZipcode(); ?></li>
		</ul>

		<p class="controls">
			<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user)) : ?>
				<a href="#" class="btn" title="Edit Plot Information" data-edit="editable" data-target="#editModalPlot">Edit</a>
			<?php endif; ?>
			<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user) && $this->User()->canShowTips()) : ?>
				<a href="#" title="Tool tips!" class="tips">Tool Tips</a>
			<?php endif; ?>
		</p>
	</div>

	<section class="photo-timeline">
		<?php
			// @TODO make a partial or whatever it is called
		?>
		<?php if ($images = $_plot->getImages()) : ?>
		<ul class="list list-block">
			<?php foreach ($images as $image) : ?>
				<li><img src="<?= Bootstrap::getBaseUrl('media/plot') . $image->getThumbnail(); ?>" width="150px" title="<?php echo $image->getCaption(); ?>" alt="<?php echo $image->getCaption(); ?>"></li>
			<?php endforeach; ?>
		</ul>
		<?php endif; ?>
		<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user)) : ?>
			<a href="<?php echo $this->url('plot/images', array('p' => $_plot->getId())); ?>" title="Manage Photos">Manage Photos</a>
		<?php endif; ?>
	</section>

	<ul id="tabMenu" class="list-inline">
		<li><a href="#plots" title="Where I'm Growing">Users</a></li>
		<li><a href="#socializing" title="What I'm Sharing">Status</a></li>
		<li><a href="#crops" title="What I'm Growing">Crops</a></li>
		<li><a href="#about" title="Who am I?">About</a></li>
	</ul>

	<section id="users" class="blocked-content">
		<?php if ($users = $_plot->getUsers()) : ?>
			<ul>
			<?php foreach ($users as $user) : ?>
				<li>
					<h3><a href="<?php echo $user->getUrl(); ?>" title="<?php echo $user->getName(); ?>"><?php echo $user->getName(); ?></a></h3>
					<?php echo $user->getUserRole(); ?>
				</li>
			<?php endforeach; ?>
			</ul>
		<?php else : ?>
			<p>Sorry no users associated. Get growing!</p>
		<?php endif; ?>

		<?php /** @TODO Create a modal partial/template */ ?>
		<?php if ($_session->isLoggedIn() && !$_plot->isAssociated($_session->user)) :  ?>
			<p id="get-involved">
				<a href="#getInvolvedModal" class="btn btn-success btn-large" data-toggle="modal"><span>Get Involed</span></a>
			</p>
			<div class="modal hide fade" id="getInvolvedModal">
				<div class="modal-header">
					<a class="close" data-dismiss="modal">×</a>
					<h3>Get Involved</h3>
				</div>
				<div class="modal-body">
					<form action="<?= $this->url('plot/get-involved'); ?>" type="post" id="getInvolvedForm">
						<input type="hidden" name="user_id" value="<?php echo Bootstrap::getSingleton('user/session')->user->getId(); ?>" />
						<input type="hidden" name="plot_id" value="<?php echo Zend_Registry::get('current_plot')->getId(); ?>" />
						<ul class="fieldset">
						<?php foreach (Elm_Model_Resource_Plot::$userRoles as $role) : ?>
							<?php if ($role == 'Creator') continue; ?>
							<li class="radio">
								<input type="radio" id="role<?php echo $role; ?>" class="radio-input" name="role" value="<?php echo $role; ?>">
								<label><?php echo $role; ?></label>
							</li>
						<?php endforeach; ?>
						</ul>
					</form>
				</div>
				<div class="modal-footer">
					<a href="#" class="btn" data-dismiss="modal">Close</a>
					<a href="#" class="btn btn-primary" data-submit="form" data-form="#editFormPlot">Save</a>
				</div>
			</div>
		<?php endif; ?>
	</section>

	<section id="socializing" class="blocked-content">
	<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user)) :  ?>
		<form action="<?php echo $this->url('status/create'); ?>" method="post" id="statusForm">
			<input type="hidden" name="plot_id" value="<?= $_plot->getId(); ?>" />
			<input type="hidden" name="user_id" value="<?= $_session->user->getId(); ?>" />

			<?php /** @TODO Create partial */ ?>
			<ul class="list-inline type-selection">
				<li>
					<label for="status-type-text" class="radio">
						<input type="radio" id="status-type-text" name="type" value="text" /> Text
					</label>
				</li>
				<li>
					<label for="status-type-link" class="radio">
						<input type="radio" id="status-type-link" name="type" value="link" /> Link
					</label>
				</li>
				<li>
					<label for="status-type-crop" class="radio">
						<input type="radio" id="status-type-crop" name="type" value="crop" /> Crop
					</label>
				</li>
			</ul>
			<p class="input">
				<label for="status-content">How's it growin'?</label>
				<textarea id="status-content" name="content"></textarea>
			</p>
			<p class="buttons">
				<button class="btn btn-inverse" type="submit"><span>Share</span></button>
			</p>
		</form>
	<?php endif; ?>

	<?php if ($statuses = $_plot->getStatusUpdates(10)) : ?>
		<h5>Thoughts:</h5>
		<ul class="feed">
			<?php foreach ($statuses as $status) : ?>
			<li>
				<h4><?= $status->getUser()->getName(); ?></h4>
				<p><?= $status->getCreatedAt(); ?></p>
				<p><?= $status->getContent(); ?></p>
			</li>
			<?php endforeach; ?>
		</ul>
	<?php endif; ?>
	</section>

	<section id="crops" class="blocked-content">
		Crop display
	</section>

	<section id="about" class="blocked-content">
		<div class="editable" data-title="About this plot" data-name="about" data-type="textarea">
			<?= $_plot->getAbout() ? $_plot->getAbout() : 'A little about this plot...'; ?>
		</div>
	</section>
</div>

<div class="modal hide fade edit-modal" id="editModalPlot">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">×</a>
		<h3></h3>
	</div>
	<div class="modal-body">
		<form action="<?= $this->url('plot/save'); ?>" type="post" id="editFormPlot">
			<input type="hidden" data-name="identifier" name="plot_id" value="<?= $_plot->getId(); ?>" />
			<input type="hidden" data-name="update" name="plot_update" value="" />
			<div class="wrapper"></div>
		</form>
	</div>
	<div class="modal-footer">
		<a href="#" class="btn" data-dismiss="modal">Close</a>
		<a href="#" class="btn btn-primary" data-submit="form" data-form="#editFormPlot">Save</a>
	</div>
</div>


<script>
jQuery('#statusForm').on('submit', function(e) {
	e.preventDefault();
	var $form = jQuery(this);
	var $alert = $form.find('.alert');

	if ($alert.length) {
		$alert.alert('close');
	}

	jQuery.ajax({
		url: $form.attr('action'),
		type: 'post',
		data: $form.serialize(),
		success: function(response) {
			if (!elm.success(response)) {
				return;
			}

			if (response.success) {
				jQuery.formReset($form);
				var $li = jQuery(response.html).hide();
				$form.parent().find('.feed').prepend($li);
				$li.fadeIn();
			} else {
				$alert = jQuery.createErrorAlert(response.message).hide();
			}

			if ($alert.length) {
				$form.prepend($alert);
				$alert.fadeIn();
			}
		},
		error: function() {
			elm.error("Oops! We've encountered some troubles. Try again shortly!", $form, 'prepend');
		},
		exception: function() {
			elm.error("Oops! We've encountered some troubles. Try again shortly!", $form, 'prepend');
		}
	});
	return false;
});
</script>