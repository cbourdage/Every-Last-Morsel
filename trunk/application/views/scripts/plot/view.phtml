<?php
$_session = Bootstrap::getSingleton('user/session');
$_plot = $this->plot;
?>
<?php echo $this->Message()->render(); ?>
<div class="inner-content-wrapper plot">
	<div class="top">
		<h2><span class="editable" data-title="Plot Name" data-name="name" data-type="input"><?php echo $_plot->getName(); ?></span></h2>
		<ul class="list-inline">
			<li><strong>Location</strong> <?php echo $_plot->getZipcode(); ?></li>
		</ul>

		<p class="controls">
			<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user)) : ?>
				<a href="#" class="btn" title="Edit Plot Information" data-edit="editable" data-target="#editModalPlot">Edit</a>
			<?php endif; ?>
			<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user) && $this->User()->canShowTips()) : ?>
				<a href="#"  title="Tool tips!" class="tips">Tool Tips</a>
			<?php endif; ?>
		</p>
	</div>

	<section class="photo-timeline blocked-content">
		<?php
			// @TODO make a partial or whatever it is called
		?>
		<?php if ($images = $_plot->getImages()) : ?>
		<ul class="list list-block">
			<?php foreach ($images as $image) : ?>
				<li><img src="<?= Bootstrap::getBaseUrl('media/plot') . $image->getThumbnail(); ?>" width="150px" title="<?php echo $image->getCaption(); ?>" alt="<?php echo $image->getCaption(); ?>"></li>
			<?php endforeach; ?>
		</ul>
		<?php endif; ?>
		<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user)) : ?>
			<div id="imageEditContainer">
				<a class="" href="#" id="expandImagesForm" title="Manage Photos">Manage Photos</a>
				<div class="hide">
					<form action="<?php echo $this->url('plot/image-upload', array('p' => $_plot->getId())); ?>" method="post" enctype="multipart/form-data">
						<ul class="fieldset list-block">
							<li>
								<label for="image-1" class="optional">Image</label>
								<div><input type="file" name="image[]" id="image-1"></div>
							</li>
							<li>
								<label for="caption-1" class="optional">Title/Caption</label>
								<div><input type="text" name="caption[]" id="caption-1" value=""></div>
							</li>
						</ul>
						<p class="buttons-set">
							<a href="#" id="addMore" title="Add Images">Add Another</a>
							<button type="submit" class="btn btn-primary">Upload</button>
						</p>
					</form>
				</div>
			</div>
		<?php endif; ?>
	</section>

	<ul id="tabMenu" class="list-inline">
		<li><a href="#plots" title="Where I'm Growing">Users</a></li>
		<li><a href="#socializing" title="What I'm Sharing">Status</a></li>
		<li><a href="#crops" title="What I'm Growing">Crops</a></li>
		<li><a href="#about" title="Who am I?">About</a></li>
	</ul>

	<section id="users" class="blocked-content">
		<?php echo $this->partial('plot/user/list.phtml', array('plot' => $_plot)); ?>
		<?php if ($_session->isLoggedIn() && !$_plot->isAssociated($_session->user)) :  ?>
			<?php echo $this->partial('plot/user/associate.phtml', array('plot' => $_plot)); ?>
		<?php endif; ?>
	</section>

	<section id="socializing" class="blocked-content comments">
		<?php if ($_session->isLoggedIn() && $_plot->isAssociated($_session->user)) :  ?>
			<?php echo $this->partial('plot/comment/form.phtml', array('plot' => $_plot)); ?>
		<?php endif; ?>
		<?php echo $this->partial('plot/comment/list.phtml', array('plot' => $_plot)); ?>
	</section>

	<section id="crops" class="blocked-content">
		Crop display
	</section>

	<section id="about" class="blocked-content">
		<div class="editable" data-title="About this plot" data-name="about" data-type="textarea">
			<?= $_plot->getAbout() ? $_plot->getAbout() : 'A little about this plot...'; ?>
		</div>
	</section>
</div>

<div class="modal hide fade edit-modal" id="editModalPlot">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">Ã—</a>
		<h3></h3>
	</div>
	<div class="modal-body">
		<form action="<?= $this->url('plot/save'); ?>" type="post" id="editFormPlot">
			<input type="hidden" data-name="identifier" name="plot_id" value="<?= $_plot->getId(); ?>" />
			<input type="hidden" data-name="update" name="plot_update" value="" />
			<div class="wrapper"></div>
		</form>
	</div>
	<div class="modal-footer">
		<a href="#" class="btn" data-dismiss="modal">Close</a>
		<a href="#" class="btn btn-primary" data-submit="form" data-form="#editFormPlot">Save</a>
	</div>
</div>


<script defer="defer">
!function($) {
	var total = 1;
	var $imageEditContainer = $('#imageEditContainer');
	$imageEditContainer.on('click', '#expandImagesForm', function(e) {
		e.preventDefault();
		$(this).next().slideToggle();
		$(this).parent().toggleClass('active');
	});
	$imageEditContainer.on('click', '#addMore', function(e) {
		e.preventDefault();
		total++;
		var $ulListInput = jQuery(this).parent().prev();
		var $duplicate = $ulListInput.clone();
		$duplicate.find('input').each(function() {
			var idPrefix = jQuery(this).attr('name').replace('[]', '-');
			$(this).val('').attr('id', idPrefix + total);
			$(this).parent().prev().attr('for', idPrefix + total);
		});
		$ulListInput.after($duplicate);
		return false;
	});

	$('#statusForm').on('submit', function(e) {
		e.preventDefault();
		var $form = $(this);
		var $alert = $form.find('.alert');

		if ($alert.length) {
			$alert.alert('close');
		}

		$.ajax({
			url: $form.attr('action'),
			type: 'post',
			data: $form.serialize(),
			success: function(response) {
				if (!elm.success(response)) {
					return;
				}

				if (response.success) {
					$.formReset($form);
					var $li = $(response.html).hide();
					$form.parent().find('.feed').prepend($li);
					$li.fadeIn();
				} else {
					$alert = jQuery.createErrorAlert(response.message).hide();
				}

				if ($alert.length) {
					$form.prepend($alert);
					$alert.fadeIn();
				}
			},
			error: function() {
				elm.error("Oops! We've encountered some troubles. Try again shortly!", $form, 'prepend');
			},
			exception: function() {
				elm.error("Oops! We've encountered some troubles. Try again shortly!", $form, 'prepend');
			}
		});
		return false;
	});
}(window.jQuery);
</script>